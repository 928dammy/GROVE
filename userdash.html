<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GROVE | Master Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --emerald: #10b981; --grove-deep: #061a14; --grove-leaf: #064e3b; --gold: #fbbf24; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; padding: 1rem; }
        .terminal-parent { background: var(--grove-deep); border-radius: 2.5rem; color: #ecfdf5; min-height: 600px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(16, 185, 129, 0.1); }
        .nav-pill { background: rgba(0, 0, 0, 0.3); padding: 4px; border-radius: 12px; display: flex; gap: 4px; margin: 1rem; }
        .tab-trigger { flex: 1; color: rgba(255,255,255,0.3); font-size: 8px; font-weight: 800; cursor: pointer; text-transform: uppercase; padding: 10px 0; text-align: center; border-radius: 8px; }
        .tab-trigger.active { color: #fff; background: var(--grove-leaf); }
        .tab-content { display: none; padding: 1rem; flex: 1; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; }
        .grace-card { background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 1rem; padding: 12px; margin-bottom: 8px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="max-w-md mx-auto">

    <header class="bg-white rounded-[2rem] p-5 mb-4 border border-slate-100 shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-lg font-black italic">GROVE</h1>
            <span id="user-tag" class="text-[8px] font-black bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full">SYNCING...</span>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-slate-50 p-3 rounded-2xl border"><p class="text-[7px] font-black text-slate-400 uppercase">Seed Base</p><div id="stat-seed" class="text-sm font-black italic">₵0.00</div></div>
            <div class="bg-emerald-50 p-3 rounded-2xl border"><p class="text-[7px] font-black text-emerald-600 uppercase">Grace Balance</p><div id="stat-grace" class="text-sm font-black italic">₵0.00</div></div>
        </div>
    </header>

    <main class="terminal-parent">
        <nav class="nav-pill">
            <div id="btn-orchard" class="tab-trigger active" onclick="openTab('t-orchard')">Orchard</div>
            <div id="btn-vault" class="tab-trigger" onclick="openTab('t-vault')">Vault</div>
            <div id="btn-ledger" class="tab-trigger" onclick="openTab('t-ledger')">Ledger</div>
        </nav>

        <section id="t-orchard" class="tab-content active">
            <div class="text-center mb-6">
                <p class="text-[10px] font-black text-emerald-400 uppercase tracking-widest italic">"Givers Never Lack"</p>
                <h2 id="orchard-status" class="text-xs text-slate-400 mt-1">Scanning for incoming Grace...</h2>
            </div>
            
            <div id="grace-distribution-list" class="space-y-2 mb-6">
                </div>

            <div id="harvest-zone" class="mt-auto hidden">
                <button onclick="harvestAll()" class="w-full py-4 bg-emerald-500 text-black font-black rounded-2xl text-[10px] uppercase shadow-lg transform active:scale-95 transition">Harvest All to Balance</button>
            </div>
        </section>

        <section id="t-vault" class="tab-content">
            <div class="bg-emerald-900/30 p-8 rounded-3xl text-center border border-white/5">
                <p class="text-[8px] font-black text-emerald-400 uppercase mb-2">Claim Vaulted</p>
                <h2 id="vault-display" class="text-4xl font-black italic text-white mb-8">₵0.00</h2>
                <div class="space-y-3">
                    <button onclick="moveToVault()" class="w-full py-4 bg-white text-emerald-900 rounded-2xl text-[8px] font-black uppercase">Move Grace to Vault</button>
                    <button onclick="prepWithdrawal()" class="w-full py-4 bg-emerald-500/10 text-emerald-400 border border-emerald-500/30 rounded-2xl text-[8px] font-black uppercase">Withdraw Funds</button>
                </div>
            </div>
        </section>

        <section id="t-ledger" class="tab-content">
            <div id="ledger-list" class="space-y-1"></div>
        </section>
    </main>

    <div id="withdrawModal" class="fixed inset-0 bg-black/90 hidden z-[100] items-center justify-center p-6">
        <div class="bg-white p-6 rounded-[2.5rem] w-full max-w-xs text-center">
            <p class="text-[9px] font-black text-emerald-600 uppercase italic">Terminal Payout</p>
            <div class="my-6 space-y-2 border-y border-slate-100 py-4">
                <div class="flex justify-between text-[10px]"><span class="text-slate-400">AVAILABLE</span><span id="wd-avail" class="font-black text-black">₵0.00</span></div>
                <div class="flex justify-between text-[10px]"><span class="text-rose-400">SERVICE FEE (2%)</span><span id="wd-fee" class="font-black text-rose-500">-₵0.00</span></div>
                <div class="flex justify-between text-base font-black pt-2"><span>TOTAL</span><span id="wd-final" class="text-emerald-600">₵0.00</span></div>
            </div>
            <button onclick="confirmWithdraw()" class="w-full py-4 bg-emerald-600 text-white font-black rounded-2xl text-[10px] uppercase">Process Claim</button>
            <button onclick="closeModal()" class="mt-2 text-[8px] font-black text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <script>
        const _gv = supabase.createClient("YOUR_SB_URL", "YOUR_SB_KEY");
        let userObj = null, totalVault = 0, pendingGraceTotal = 0;

        async function sync() {
            const { data: { user } } = await _gv.auth.getUser();
            if(!user) return;
            userObj = user;
            document.getElementById('user-tag').innerText = user.email.split('@')[0].toUpperCase();

            const { data: ledger } = await _gv.from('ledger').select('*').eq('user_id', user.id).order('created_at', { ascending: false });

            let seed = 0, graceBal = 0, vault = 0, pendingGrace = 0;
            let distribHTML = "";
            let ledgerHTML = "";

            ledger?.forEach(item => {
                const amt = parseFloat(item.amount);
                // Distributed but not yet "Harvested"
                if(item.entry_type === 'grace') {
                    pendingGrace += amt;
                    distribHTML += `
                        <div class="grace-card flex justify-between items-center">
                            <div><p class="text-[7px] font-black text-emerald-500 uppercase">Distribution</p><p class="text-[9px] text-white italic">${item.description}</p></div>
                            <p class="text-xs font-black text-emerald-400">+₵${amt.toFixed(2)}</p>
                        </div>`;
                }
                // Categorize Totals
                if(item.entry_type === 'seed') seed += amt;
                if(item.entry_type === 'grace_claimed') graceBal += amt;
                if(item.entry_type === 'vault_deposit') vault += amt;
                if(item.entry_type === 'withdrawal') vault += amt; // amount is negative

                ledgerHTML += `
                    <div class="p-3 flex justify-between text-[9px] border-b border-white/5">
                        <span class="text-slate-400 uppercase">${item.entry_type.replace('_',' ')}</span>
                        <span class="${amt >= 0 ? 'text-emerald-400' : 'text-rose-400'} font-black">₵${Math.abs(amt).toFixed(2)}</span>
                    </div>`;
            });

            pendingGraceTotal = pendingGrace;
            totalVault = vault;

            document.getElementById('stat-seed').innerText = `₵${seed.toFixed(2)}`;
            document.getElementById('stat-grace').innerText = `₵${graceBal.toFixed(2)}`;
            document.getElementById('vault-display').innerText = `₵${vault.toFixed(2)}`;
            document.getElementById('grace-distribution-list').innerHTML = distribHTML;
            document.getElementById('ledger-list').innerHTML = ledgerHTML;

            // Toggle UI states
            document.getElementById('orchard-status').innerText = pendingGrace > 0 ? "New Grace has arrived!" : "Waiting for Grace to appear...";
            document.getElementById('harvest-zone').style.display = pendingGrace > 0 ? 'block' : 'none';
        }

        async function harvestAll() {
            if(pendingGraceTotal <= 0) return;
            // 1. Move total pending to 'grace_claimed'
            await _gv.from('ledger').insert([{ 
                user_id: userObj.id, amount: pendingGraceTotal, entry_type: 'grace_claimed', description: 'Harvested from Orchard' 
            }]);
            // 2. Clear out the 'grace' entries
            await _gv.from('ledger').delete().eq('user_id', userObj.id).eq('entry_type', 'grace');
            sync();
        }

        async function moveToVault() {
            const graceVal = parseFloat(document.getElementById('stat-grace').innerText.replace('₵',''));
            if(graceVal <= 0) return alert("Nothing to vault!");
            
            await _gv.from('ledger').insert([
                { user_id: userObj.id, amount: -graceVal, entry_type: 'grace_claimed', description: 'Moved to Vault' },
                { user_id: userObj.id, amount: graceVal, entry_type: 'vault_deposit', description: 'Received from Balance' }
            ]);
            sync();
        }

        function prepWithdrawal() {
            if(totalVault <= 0) return alert("Vault is empty!");
            const fee = totalVault * 0.02;
            document.getElementById('wd-avail').innerText = `₵${totalVault.toFixed(2)}`;
            document.getElementById('wd-fee').innerText = `-₵${fee.toFixed(2)}`;
            document.getElementById('wd-final').innerText = `₵${(totalVault - fee).toFixed(2)}`;
            document.getElementById('withdrawModal').style.display = 'flex';
        }

        async function confirmWithdraw() {
            await _gv.from('ledger').insert([{ 
                user_id: userObj.id, amount: -totalVault, entry_type: 'withdrawal', description: 'Payout (2% Fee Ded.)' 
            }]);
            closeModal();
            sync();
        }

        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-trigger').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id.split('-')[1]).classList.add('active');
        }

        function closeModal() { document.getElementById('withdrawModal').style.display = 'none'; }

        // Start & Realtime
        sync();
        _gv.channel('ledger-db').on('postgres_changes', {event:'*', schema:'public', table:'ledger'}, () => sync()).subscribe();
    </script>
</body>
</html>
