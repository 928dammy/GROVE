<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GROVE | Master Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; min-height: 100vh; margin: 0; overflow-x: hidden; }
        .auth-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 1.5rem; }
        .nav-link { display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.4; transition: 0.3s; cursor: pointer; position: relative; }
        .nav-link.active { opacity: 1; color: #10b981; }
        .tab-content { display: none; padding-bottom: 120px; }
        .tab-content.active { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .input-box { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); color: white; border-radius: 1rem; padding: 1rem; width: 100%; outline: none; font-size: 14px; }
        .btn-verify { background: #10b981; color: #020617; font-weight: 900; }
        .status-pill { font-size: 7px; font-weight: 900; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        
        /* Carousel Billboard */
        .billboard-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 12px; padding: 10px 0; }
        .billboard-card { min-width: 85%; scroll-snap-align: start; border-radius: 2rem; overflow: hidden; position: relative; height: 220px; border: 1px solid rgba(255,255,255,0.1); background: #0f172a; }
        .billboard-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, rgba(2,6,23,1) 10%, rgba(2,6,23,0) 100%); display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; }
        
        .badge { position: absolute; top: 0; right: -5px; background: #f43f5e; color: white; font-size: 8px; padding: 2px 6px; border-radius: 10px; font-weight: 900; border: 2px solid #020617; }
        
        /* Modal for Full Node Info */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .view-hidden { display: none !important; }
    </style>
</head>
<body class="bg-slate-950">

    <div id="nodeModal" class="modal">
        <div class="auth-card w-full max-w-md p-8 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-500 font-black">CLOSE</button>
            <h2 id="mNodeTitle" class="text-xl font-black text-emerald-500 mb-1">NODE DATA</h2>
            <p id="mNodeEmail" class="text-[10px] text-slate-400 mb-6 font-bold uppercase"></p>
            <div id="mNodeContent" class="space-y-4"></div>
        </div>
    </div>

    <header class="p-6 sticky top-0 z-40 bg-slate-950/80 backdrop-blur-md border-b border-white/5">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-xl font-black italic tracking-tighter text-emerald-500">.admin</h1>
                <p class="text-[8px] font-black text-amber-500 uppercase mt-1 tracking-widest">Givers Never Lack</p>
            </div>
            <div class="text-right">
                <p id="stat-pool" class="text-lg font-black text-emerald-400 italic">â‚µ0.00</p>
                <p class="text-[7px] font-black text-slate-500 uppercase">Total Pool</p>
            </div>
        </div>
        <div class="flex justify-between items-center">
            <div id="admin-email" class="text-[7px] font-bold text-slate-500 uppercase">Terminal Online</div>
            <button onclick="rebornApp()" class="text-[7px] font-black text-rose-500 bg-rose-500/10 px-3 py-1 rounded-lg border border-rose-500/20">REBORN APP</button>
        </div>
    </header>

    <main class="p-4">
        
        <section id="nodes" class="tab-content active">
            <div class="auth-card p-6 mb-4">
                <h3 class="text-xs font-black uppercase text-blue-400 mb-4 italic">Security Checkpoint</h3>
                <div class="space-y-3">
                    <input type="email" id="targetEmail" placeholder="Node Email" class="input-box">
                    <div class="flex gap-2">
                        <input type="number" id="minRange" placeholder="Min â‚µ" class="input-box">
                        <input type="number" id="maxRange" placeholder="Max â‚µ" class="input-box">
                    </div>
                    <button onclick="updateNodeStatus()" class="w-full py-4 btn-verify rounded-2xl text-[10px] uppercase">Verify & Lift Lockout</button>
                </div>
            </div>

            <div class="mb-4">
                <input type="text" id="nodeSearch" oninput="renderNodes()" placeholder="Search Name, Email, or Phone..." class="input-box border-emerald-500/10">
            </div>
            
            <div id="nodeList" class="space-y-3"></div>
        </section>

        <section id="missions" class="tab-content">
            <div class="auth-card p-6 mb-6">
                <h3 id="missionFormTitle" class="text-sm font-black uppercase text-amber-500 mb-4 italic">Deploy Impact Mission</h3>
                <div class="space-y-3">
                    <input type="hidden" id="editMissionId">
                    <select id="missionCategory" class="input-box bg-slate-900">
                        <option value="Social Need">Social Need</option>
                        <option value="Youth Empowerment">Youth Empowerment</option>
                        <option value="Environment">Environment</option>
                    </select>
                    <input type="text" id="missionTitle" placeholder="Mission Name" class="input-box">
                    <textarea id="missionDesc" placeholder="The Narrative..." class="input-box h-20"></textarea>
                    <input type="text" id="missionImage" placeholder="Image URL" class="input-box">
                    <input type="number" id="missionGoal" placeholder="Goal â‚µ" class="input-box">
                    <div class="flex gap-2">
                        <button onclick="publishMission()" id="missionSubmitBtn" class="flex-1 py-4 bg-emerald-600 text-white font-black rounded-2xl text-[9px] uppercase">Broadcast</button>
                        <button onclick="resetMissionForm()" id="missionCancelBtn" class="view-hidden px-4 bg-slate-800 text-white font-black rounded-2xl text-[9px] uppercase">Cancel</button>
                    </div>
                </div>
            </div>
            <div class="billboard-container no-scrollbar" id="billboardContent"></div>
        </section>

        <section id="harvest" class="tab-content">
             <div class="auth-card p-6 mb-4">
                <h3 class="text-sm font-black uppercase text-emerald-500 mb-4 italic">Grace/Wither Broadcast</h3>
                <p class="text-[9px] text-slate-400 mb-4 uppercase">Directly add funds to all active node vaults</p>
                <input type="number" id="hAmount" placeholder="Amount per Node â‚µ" class="input-box mb-3">
                <button onclick="broadcastGrace()" class="w-full py-4 bg-emerald-600 text-white font-black rounded-2xl text-xs uppercase">RELEASE GRACE</button>
             </div>
             <div class="auth-card p-6">
                <h3 class="text-sm font-black uppercase text-rose-500 mb-4 italic">System Wither</h3>
                <p class="text-[9px] text-slate-400 mb-4 uppercase">Reduce all active node vaults (Emergency Recall)</p>
                <input type="number" id="wAmount" placeholder="Deduction â‚µ" class="input-box mb-3">
                <button onclick="broadcastWither()" class="w-full py-4 bg-rose-600 text-white font-black rounded-2xl text-xs uppercase">ENGAGE WITHER</button>
             </div>
        </section>

        <section id="messages" class="tab-content">
            <div id="chatHeader" class="view-hidden mb-4 p-4 auth-card border-emerald-500/20 flex items-center justify-between">
                <div>
                    <p class="text-[8px] font-black text-emerald-500 uppercase">Conversation With</p>
                    <h2 id="activeChatPartner" class="text-sm font-black text-white">---</h2>
                </div>
                <button onclick="closeChat()" class="text-[9px] font-black bg-white/10 px-4 py-2 rounded-lg">BACK</button>
            </div>
            <div id="contactList" class="space-y-2"></div>
            <div id="chatBox" class="view-hidden flex flex-col h-[50vh]">
                <div id="msgFeed" class="flex-1 overflow-y-auto space-y-2 mb-4 p-2 no-scrollbar"></div>
                <div class="flex gap-2">
                    <input type="text" id="adminMsgInput" placeholder="Message..." class="input-box">
                    <button onclick="sendMsg()" class="bg-emerald-500 text-black px-6 rounded-xl font-black text-[10px]">SEND</button>
                </div>
            </div>
        </section>

        <section id="payouts" class="tab-content"><div id="payoutList" class="space-y-2"></div></section>
        <section id="ledger" class="tab-content"><div id="ledgerTable" class="auth-card divide-y divide-white/5"></div></section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-slate-950 border-t border-white/10 flex justify-around items-center z-50">
        <div class="nav-link active" onclick="openTab(event, 'nodes')"><span>ðŸ‘¥</span><p class="text-[7px] font-black uppercase">Nodes</p></div>
        <div class="nav-link" onclick="openTab(event, 'missions')"><span>ðŸš€</span><p class="text-[7px] font-black uppercase">Impact</p></div>
        <div class="nav-link" onclick="openTab(event, 'harvest')"><span>ðŸŒ¿</span><p class="text-[7px] font-black uppercase">Harvest</p></div>
        <div class="nav-link" onclick="openTab(event, 'messages')">
            <div id="unreadBadge" class="badge view-hidden">0</div>
            <span>ðŸ’¬</span><p class="text-[7px] font-black uppercase">Chat</p>
        </div>
        <div class="nav-link" onclick="openTab(event, 'payouts')"><span>ðŸ’°</span><p class="text-[7px] font-black uppercase">Payouts</p></div>
    </nav>

    <script>
        const SB_URL = window.CONFIG?.SB_URL || "https://efiacszdzogknbucfgeu.supabase.co";
        const SB_KEY = window.CONFIG?.SB_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmaWFjc3pkem9na25idWNmZ2V1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MjYyMDYsImV4cCI6MjA4NjQwMjIwNn0.F_fle-dOk-g1Pvh5ezDinOAzGWwlIBhLYvZkNAc2Ouc";
        const _gv = supabase.createClient(SB_URL, SB_KEY);
        let adminUser = null, allNodes = [], currentChatId = null, nodeStats = {};

        async function sync() {
            const { data: nodes } = await _gv.from('profiles').select('*');
            const { data: ledger } = await _gv.from('ledger').select('*').order('created_at', { ascending: false });
            const { data: missions } = await _gv.from('system_events').select('*').eq('type', 'mission').order('created_at', { ascending: false });
            const { data: msgs } = await _gv.from('messages').select('*').order('created_at', { ascending: false });
            
            allNodes = nodes || [];
            
            let globalSeeded = 0, globalTaken = 0;
            nodeStats = {};
            nodes?.forEach(n => nodeStats[n.id] = { s:0, v:0, w:0 });

            ledger?.forEach(l => {
                const amt = Math.abs(l.amount);
                if(l.entry_type === 'seed') globalSeeded += amt;
                if(l.entry_type === 'withdrawal') globalTaken += amt;
                if(nodeStats[l.user_id]) {
                    if(l.entry_type === 'seed' && !l.description.includes('Vault')) nodeStats[l.user_id].s += amt;
                    if(l.description.includes('Vault')) nodeStats[l.user_id].v += amt;
                    if(l.entry_type === 'withdrawal') nodeStats[l.user_id].w += amt;
                }
            });

            document.getElementById('stat-pool').innerText = `â‚µ${(globalSeeded - globalTaken).toFixed(2)}`;
            renderNodes();
            renderMissions(missions);
            renderMessages(msgs);
            renderLedger(ledger);
        }

        function renderNodes() {
            const term = document.getElementById('nodeSearch').value.toLowerCase();
            const filtered = allNodes.filter(n => 
                (n.full_name || '').toLowerCase().includes(term) || 
                (n.email || '').toLowerCase().includes(term) || 
                (n.phone_number || '').toLowerCase().includes(term)
            );

            document.getElementById('nodeList').innerHTML = filtered.map(n => {
                const s = nodeStats[n.id] || {s:0, v:0, w:0};
                const v = n.is_gifter && n.current_range_max > 0;
                return `
                <div class="auth-card p-4 border ${v ? 'border-emerald-500/20' : 'border-rose-500/30'}">
                    <div class="flex justify-between items-start mb-3" onclick="showNodeDetails('${n.id}')">
                        <div>
                            <p class="text-[10px] font-black uppercase text-white">${n.full_name || 'New Node'}</p>
                            <p class="text-[7px] text-emerald-500 font-bold">${n.phone_number || 'No Contact'}</p>
                        </div>
                        <span class="status-pill ${v ? 'bg-emerald-500/20 text-emerald-500' : 'bg-rose-500/20 text-rose-500'}">${v ? 'Verified' : 'Locked'}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="quickVerify('${n.email}')" class="flex-1 py-2 bg-emerald-500 text-black text-[8px] font-black rounded-lg uppercase">Verify</button>
                        <button onclick="showNodeDetails('${n.id}')" class="flex-1 py-2 bg-white/5 text-white text-[8px] font-black rounded-lg uppercase">Profile</button>
                    </div>
                </div>`;
            }).join('');
        }

        function showNodeDetails(id) {
            const n = allNodes.find(x => x.id === id);
            const s = nodeStats[id];
            document.getElementById('mNodeTitle').innerText = n.full_name || 'ANONYMOUS';
            document.getElementById('mNodeEmail').innerText = n.email;
            document.getElementById('mNodeContent').innerHTML = `
                <div class="grid grid-cols-2 gap-3 text-[10px] font-bold">
                    <div class="bg-black/40 p-3 rounded-xl"><p class="text-slate-500 text-[8px]">PHONE</p>${n.phone_number || 'N/A'}</div>
                    <div class="bg-black/40 p-3 rounded-xl"><p class="text-slate-500 text-[8px]">CAP</p>â‚µ${n.current_range_max}</div>
                    <div class="bg-black/40 p-3 rounded-xl"><p class="text-slate-500 text-[8px]">VAULT</p>â‚µ${(s.v - s.w).toFixed(2)}</div>
                    <div class="bg-black/40 p-3 rounded-xl"><p class="text-slate-500 text-[8px]">SEEDED</p>â‚µ${s.s.toFixed(2)}</div>
                    <div class="col-span-2 bg-black/40 p-3 rounded-xl"><p class="text-slate-500 text-[8px]">ID</p>${n.id}</div>
                </div>
            `;
            document.getElementById('nodeModal').classList.add('active');
        }

        async function broadcastGrace() {
            const amt = parseFloat(document.getElementById('hAmount').value);
            if(!amt) return alert("Enter amount.");
            for(let node of allNodes) {
                await _gv.from('ledger').insert([{ user_id: node.id, amount: amt, entry_type: 'seed', description: 'System Grace (Vault)' }]);
            }
            alert("Grace Distributed."); sync();
        }

        async function broadcastWither() {
            const amt = parseFloat(document.getElementById('wAmount').value);
            if(!amt) return alert("Enter amount.");
            for(let node of allNodes) {
                await _gv.from('ledger').insert([{ user_id: node.id, amount: -amt, entry_type: 'withdrawal', description: 'System Wither' }]);
            }
            alert("Wither Completed."); sync();
        }

        async function rebornApp() {
            if(confirm("DANGER: This wipes all data. Continue?")) {
                if(prompt("Type 'REBORN' to confirm:") === 'REBORN') {
                    await _gv.from('ledger').delete().neq('id', '0000');
                    await _gv.from('messages').delete().neq('id', '0000');
                    await _gv.from('profiles').delete().neq('id', adminUser.id);
                    location.reload();
                }
            }
        }

        function renderMessages(msgs) {
            const unread = msgs.filter(m => m.receiver_id === adminUser?.id && !m.is_read).length;
            const b = document.getElementById('unreadBadge');
            unread > 0 ? (b.innerText = unread, b.classList.remove('view-hidden')) : b.classList.add('view-hidden');

            if(currentChatId) {
                const partner = allNodes.find(n => n.id === currentChatId);
                document.getElementById('activeChatPartner').innerText = partner?.full_name || partner?.email;
                const thread = msgs.filter(m => m.sender_id === currentChatId || m.receiver_id === currentChatId).reverse();
                document.getElementById('msgFeed').innerHTML = thread.map(m => `
                    <div class="flex ${m.sender_id === adminUser.id ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[80%] p-3 rounded-2xl text-[11px] font-bold ${m.sender_id === adminUser.id ? 'bg-emerald-500 text-black' : 'bg-white/10 text-white'}">${m.content}</div>
                    </div>
                `).join('');
            } else {
                document.getElementById('contactList').innerHTML = allNodes.map(n => `
                    <div onclick="openChat('${n.id}')" class="auth-card p-4 flex justify-between items-center cursor-pointer mb-2">
                        <p class="text-[10px] font-black uppercase">${n.full_name || n.email}</p>
                        <span>â†’</span>
                    </div>
                `).join('');
            }
        }

        function openChat(id) { 
            currentChatId = id; 
            document.getElementById('contactList').classList.add('view-hidden');
            document.getElementById('chatHeader').classList.remove('view-hidden');
            document.getElementById('chatBox').classList.remove('view-hidden');
            sync();
        }

        function closeChat() {
            currentChatId = null;
            document.getElementById('contactList').classList.remove('view-hidden');
            document.getElementById('chatHeader').classList.add('view-hidden');
            document.getElementById('chatBox').classList.add('view-hidden');
        }

        async function sendMsg() {
            const input = document.getElementById('adminMsgInput');
            if(!input.value || !currentChatId) return;
            await _gv.from('messages').insert([{ sender_id: adminUser.id, receiver_id: currentChatId, content: input.value, sender_name: 'ADMIN' }]);
            input.value = ''; sync();
        }

        function renderMissions(missions) {
            document.getElementById('billboardContent').innerHTML = missions?.map(m => `
                <div class="billboard-card">
                    <img src="${m.image_url}" class="w-full h-full object-cover opacity-50">
                    <div class="billboard-overlay">
                        <h4 class="text-sm font-black italic">${m.title}</h4>
                        <div class="flex justify-between items-center">
                            <p class="text-[9px] font-black text-emerald-400">â‚µ${m.value}</p>
                            <button onclick="editMission('${encodeURIComponent(JSON.stringify(m))}')" class="text-[8px] font-black text-amber-500 uppercase">Edit</button>
                        </div>
                    </div>
                </div>`).join('');
        }

        async function updateNodeStatus() {
            const e = document.getElementById('targetEmail').value;
            const m = document.getElementById('maxRange').value;
            await _gv.from('profiles').update({ is_gifter: true, current_range_max: parseFloat(m) }).eq('email', e);
            alert("Authorized."); sync();
        }

        async function quickVerify(email) {
            await _gv.from('profiles').update({ is_gifter: true, current_range_max: 500 }).eq('email', email);
            sync();
        }

        function openTab(e, n) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(n).classList.add('active');
            e.currentTarget.classList.add('active');
            if(n === 'messages') closeChat();
        }

        function closeModal() { document.getElementById('nodeModal').classList.remove('active'); }

        async function init() {
            const { data: { user } } = await _gv.auth.getUser();
            if (!user) { window.location.href = 'consoleenter.html'; return; }
            adminUser = user;
            sync();
            _gv.channel('any').on('postgres_changes', { event: '*', schema: 'public' }, () => sync()).subscribe();
        }
        init();
    </script>
</body>
</html>
